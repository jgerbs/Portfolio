@* Jack Gerber - A01266976
   Date: Nov 05, 2025 *@
 
@model Tuple<BlogApp.Models.ApplicationUser, List<BlogApp.Models.Article>>

@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{
    var user = Model?.Item1;
    var articles = Model?.Item2 ?? new List<Article>();
    ViewData["Title"] = user != null ? $"Welcome, {user.FirstName}!" : "Home Page";
}

<div class="d-flex justify-content-between align-items-center">
    <h2>@ViewData["Title"]</h2>

    <div class="d-flex justify-content-end align-items-center">
        <!-- Filter Button -->
        <button class="btn btn-secondary me-3" data-bs-toggle="modal" data-bs-target="#filterModal">Filter</button>

        @if (User.Identity.IsAuthenticated)
        {
            var currentUser = await UserManager.GetUserAsync(User);
            var userRoles = await UserManager.GetRolesAsync(currentUser);

            if (userRoles.Contains("Contributor") || userRoles.Contains("Admin"))
            {
                <a href="@Url.Action("Create", "Article")" class="btn btn-primary">Create New Article</a>
            }
        }
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Filter Articles by Date Posted</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="get" asp-action="Index">
                    <div class="mb-3">
                        <label for="StartDate" class="form-label">From</label>
                        <input type="date" class="form-control" id="StartDate" name="startDate">
                    </div>
                    <div class="mb-3">
                        <label for="EndDate" class="form-label">To</label>
                        <input type="date" class="form-control" id="EndDate" name="endDate">
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Apply</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div>
    <p>Here's the latest news:</p>

    @if (articles.Any())
    {
        @foreach (var article in articles.OrderByDescending(a => a.DatePosted))
        {
            var contributor = await UserManager.FindByNameAsync(article.ContributorUsername);

            bool isOwner = User.Identity.IsAuthenticated &&
                        article.ContributorUsername == User.Identity.Name;

            bool isAdmin = User.IsInRole("Admin");

        <div class="article-card fade-in">

            <!-- Article Cover Image -->
            @if (!string.IsNullOrEmpty(article.CoverImageUrl))
            {
                <img class="article-image" src="@article.CoverImageUrl" alt="@article.Title">
            }

            <!-- Content Area -->
            <div class="article-info">

                <h2 class="article-title">@article.Title</h2>

                <p class="article-meta">
                    <strong>@contributor?.FirstName @contributor?.LastName</strong> — 
                    @article.DatePosted.ToLocalTime().ToString("MMMM dd, yyyy")
                </p>

                <p class="article-description">
                    @article.ShortDescription
                </p>

                <!-- Buttons (aligned right) -->
                <div class="article-buttons">

                    <!-- READ is visible to everyone -->
                    <a class="article-btn btn-read"
                    asp-controller="Article"
                    asp-action="Details"
                    asp-route-id="@article.ArticleId">
                    Read
                    </a>

                    @* Only show Edit if user is authenticated AND either Admin or article owner *@
                    @if (User.Identity.IsAuthenticated && (isAdmin || isOwner))
                    {
                        <a class="article-btn btn-edit"
                        asp-controller="Article"
                        asp-action="Edit"
                        asp-route-id="@article.ArticleId">
                        Edit
                        </a>
                    }

                    @* Only show Delete if user is Admin or article owner*@
                    @if (User.Identity.IsAuthenticated && (isAdmin || isOwner))
                    {
                        <button class="article-btn btn-delete"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal-@article.ArticleId">
                            Delete
                        </button>
                    }
                </div>

            </div>

        </div>

        <!-- DELETE MODAL -->
        @if (isOwner || isAdmin)
        {
            <div class="modal fade custom-modal" id="deleteModal-@article.ArticleId" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content modal-theme">

                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            <p>Are you sure you want to delete:</p>
                            <h4 class="modal-article-title">@article.Title</h4>
                            <p>This action cannot be undone.</p>
                        </div>

                        <div class="modal-footer">
                            <button class="modal-btn modal-cancel" data-bs-dismiss="modal">Cancel</button>

                            <form asp-controller="Article"
                                asp-action="DeleteConfirmed"
                                asp-route-id="@article.ArticleId"
                                method="post">
                                <button type="submit" class="modal-btn modal-delete">
                                    Yes, Delete
                                </button>
                            </form>

                        </div>

                    </div>
                </div>
            </div>
        }
        }

    }
    else
    {
        <p>No articles available.</p>
    }
</div>
